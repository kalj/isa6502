#!/usr/bin/python3
#
#

import sys
from pathlib import Path
import argparse
from assembly import assemble, encode_program, SyntaxError

def auto_int(x):
    return int(x, 0)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='6502 Assembler')
    parser.add_argument('input', help='name of source file to assemble')
    parser.add_argument('-v','--verbose',
                        action='store_true',
                        help='enable verbose output')
    parser.add_argument('-o','--output',
                        default='a.out',
                        help='name of output file')

    args = parser.parse_args()

    inputfilename=args.input
    outputfilename=args.output

    raw_source = open(inputfilename,"r").readlines()

    try:
        sections = assemble(raw_source)

    except SyntaxError as e:
        linum = e.get_linum()
        if linum:
            print(f"SyntaxError on line {linum}: {e}", file=sys.stderr)
            print(raw_source[linum].rstrip(), file=sys.stderr)
        else:
            print(f"SyntaxError: {e}", file=sys.stderr)
        sys.exit(1)

    if args.verbose:
        print("Parsed code:")

        first_section=True
        for section in sections:
            if first_section:
                first_section = False
            else:
                print('...')

            addr = section['base_address']
            source = []
            for s in section['statements']:
                instr_bytes = s.encode()
                bytes_str = " ".join([f"{b:02x}" for b in instr_bytes])
                source.append( (f"{addr:04x}",bytes_str,str(s)) )
                addr += s.size()
            widths = [max(len(s) for s in strs) for strs in zip(*source)]

            for line in source:
                print("{}  {}  {}".format(line[0],line[1].ljust(widths[1]),line[2]))

    prog = encode_program(sections)

    if outputfilename == '-':
        sys.stdout.buffer.write(prog)
    else:
        out_path = Path(outputfilename)
        out_path.write_bytes(prog)
